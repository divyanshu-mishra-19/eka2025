name: Slack Commit Notification
on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Commit Details
        id: commit
        run: |
          # Get commit info
          echo "hash=$(git log -1 --pretty=format:'%H')" >> $GITHUB_OUTPUT
          echo "short_hash=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an <%ae>')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "body=$(git log -1 --pretty=format:'%b')" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          # Check for PR in commit message
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          if [[ "$COMMIT_MSG" =~ Merge\ pull\ request\ #([0-9]+) ]]; then
            PR_NUM="${BASH_REMATCH[1]}"
            echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
            # Extract title after PR number
            PR_TITLE=$(echo "$COMMIT_MSG" | sed 's/.*Merge pull request #[0-9]* from [^ ]* //')
            echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" =~ \(#([0-9]+)\)$ ]]; then
            PR_NUM="${BASH_REMATCH[1]}"
            echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
            PR_TITLE=$(echo "$COMMIT_MSG" | sed 's/ (#[0-9]*)//')
            echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "pr_title=" >> $GITHUB_OUTPUT
          fi
          
          # Get file changes
          if [ $(git rev-list --count HEAD) -gt 1 ]; then
            echo "files_changed=$(git diff --name-only HEAD~1 HEAD | wc -l)" >> $GITHUB_OUTPUT
            echo "stats=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo 'No stats available')" >> $GITHUB_OUTPUT
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | head -5)
          else
            echo "files_changed=$(git diff --name-only HEAD | wc -l)" >> $GITHUB_OUTPUT
            echo "stats=$(git diff --shortstat HEAD 2>/dev/null || echo 'No stats available')" >> $GITHUB_OUTPUT
            CHANGED_FILES=$(git diff --name-only HEAD | head -5)
          fi
          
          # Format changed files
          if [ -n "$CHANGED_FILES" ]; then
            FILES_LIST=$(echo "$CHANGED_FILES" | sed 's/^/â€¢ /g' | tr '\n' ' ')
            echo "changed_files_list=${FILES_LIST}" >> $GITHUB_OUTPUT
          else
            echo "changed_files_list=No files listed" >> $GITHUB_OUTPUT
          fi

      - name: Build Slack Payload
        id: build-payload
        run: |
          # Create a clean JSON payload
          if [ "${{ steps.commit.outputs.is_pr }}" = "true" ]; then
            PR_SECTION="{
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*ðŸ“‹ Pull Request:*\\n<https://github.com/${{ github.repository }}/pull/${{ steps.commit.outputs.pr_number }}|#${{ steps.commit.outputs.pr_number }} - ${{ steps.commit.outputs.pr_title }}>\"
                  }
                },"
          else
            PR_SECTION=""
          fi
          
          if [ -n "${{ steps.commit.outputs.body }}" ]; then
            BODY_SECTION="{
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*ðŸ“„ Commit Description:*\\n${{ steps.commit.outputs.body }}\"
                  }
                },"
          else
            BODY_SECTION=""
          fi
          
          PAYLOAD=$(cat << EOF
          {
            "text": "ðŸš€ New commit to main by ${{ steps.commit.outputs.author }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸš€ Production Deployment",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Deployed By:*\\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ðŸ‘¤ Who wrote the code:*\\n${{ steps.commit.outputs.author }}"
                }
              },
              ${PR_SECTION}
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ðŸ“ What they did:*\\n\\\`\\\`\\\`${{ steps.commit.outputs.message }}\\\`\\\`\\\`"
                }
              },
              ${BODY_SECTION}
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ðŸ“Š Files Changed:*\\n${{ steps.commit.outputs.files_changed }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ðŸ“ˆ Stats:*\\n${{ steps.commit.outputs.stats }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ðŸ“ Modified Files:*\\n${{ steps.commit.outputs.changed_files_list }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ðŸ• When:*\\n${{ steps.commit.outputs.date }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ðŸ”— Commit Link:*\\n<https://github.com/${{ github.repository }}/commit/${{ steps.commit.outputs.hash }}|${{ steps.commit.outputs.short_hash }}>"
                  }
                ]
              }
            ]
          }
          EOF
          )
          
          # Remove any empty trailing commas (JSON invalid)
          PAYLOAD=$(echo "$PAYLOAD" | sed 's/,\s*{}/{/g' | sed 's/,\s*]/]/g')
          echo "payload=${PAYLOAD}" >> $GITHUB_OUTPUT

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: ${{ steps.build-payload.outputs.payload }}
