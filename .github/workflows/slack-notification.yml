name: Slack ‚Äì Detailed Commit Notification

on:
  push:
    branches:
      - main

jobs:
  slack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Get full history for comparison
          
      - name: Extract comprehensive commit info
        id: commit-info
        run: |
          # Get commit details
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_BODY=$(git log -1 --pretty=format:"%b")
          AUTHOR_NAME=$(git log -1 --pretty=format:"%an")
          AUTHOR_EMAIL=$(git log -1 --pretty=format:"%ae")
          COMMITTER_NAME=$(git log -1 --pretty=format:"%cn")
          COMMITTER_EMAIL=$(git log -1 --pretty=format:"%ce")
          COMMIT_DATE=$(git log -1 --pretty=format:"%cd" --date=format:"%Y-%m-%d %H:%M:%S UTC")
          
          # Get changed files and stats
          if [ $(git rev-list --count HEAD) -gt 1 ]; then
            CHANGED_FILES_COUNT=$(git diff --name-only HEAD~1 HEAD | wc -l)
            GIT_STATS=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "0 files changed")
            CHANGED_FILES_LIST=$(git diff --name-only HEAD~1 HEAD | head -10 | tr '\n' ',' | sed 's/,/, /g')
          else
            CHANGED_FILES_COUNT=$(git diff --name-only HEAD | wc -l)
            GIT_STATS=$(git diff --shortstat HEAD 2>/dev/null || echo "0 files changed")
            CHANGED_FILES_LIST=$(git diff --name-only HEAD | head -10 | tr '\n' ',' | sed 's/,/, /g')
          fi
          
          # Check if this is a PR merge
          IS_PR="false"
          PR_NUMBER=""
          PR_TITLE=""
          
          # Pattern 1: Standard GitHub merge "Merge pull request #123"
          if [[ "$COMMIT_MSG" =~ Merge\ pull\ request\ #([0-9]+) ]]; then
            IS_PR="true"
            PR_NUMBER="${BASH_REMATCH[1]}"
            # Extract PR title (everything after "from branchname")
            PR_TITLE=$(echo "$COMMIT_MSG" | sed -E 's/.*Merge pull request #[0-9]+ from [^ ]+ //')
          
          # Pattern 2: Squash merge with (#123) at end
          elif [[ "$COMMIT_MSG" =~ \(#([0-9]+)\)$ ]]; then
            IS_PR="true"
            PR_NUMBER="${BASH_REMATCH[1]}"
            # Remove PR number from end to get title
            PR_TITLE=$(echo "$COMMIT_MSG" | sed 's/ (#[0-9]*)//')
          fi
          
          # Get author GitHub profile
          AUTHOR_PROFILE=""
          if [[ "$AUTHOR_EMAIL" == *"@users.noreply.github.com" ]]; then
            GITHUB_USER=$(echo "$AUTHOR_EMAIL" | cut -d'@' -f1)
            AUTHOR_PROFILE="https://github.com/${GITHUB_USER}"
          fi
          
          # Set outputs
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "full_sha=$FULL_SHA" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_body=$COMMIT_BODY" >> $GITHUB_OUTPUT
          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "author_profile=$AUTHOR_PROFILE" >> $GITHUB_OUTPUT
          echo "committer_name=$COMMITTER_NAME" >> $GITHUB_OUTPUT
          echo "committer_email=$COMMITTER_EMAIL" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "changed_files_count=$CHANGED_FILES_COUNT" >> $GITHUB_OUTPUT
          echo "git_stats=$GIT_STATS" >> $GITHUB_OUTPUT
          echo "changed_files_list=$CHANGED_FILES_LIST" >> $GITHUB_OUTPUT
          echo "is_pr=$IS_PR" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
      
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # URLs
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit-info.outputs.full_sha }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          
          # Author display
          AUTHOR_DISPLAY="${{ steps.commit-info.outputs.author_name }}"
          if [ -n "${{ steps.commit-info.outputs.author_profile }}" ]; then
            AUTHOR_DISPLAY="<${{ steps.commit-info.outputs.author_profile }}|${{ steps.commit-info.outputs.author_name }}>"
          fi
          
          # PR section if applicable
          PR_SECTION=""
          if [ "${{ steps.commit-info.outputs.is_pr }}" = "true" ]; then
            PR_URL="${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.commit-info.outputs.pr_number }}"
            PR_SECTION=$(cat << EOF
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üìã Pull Request Merged*\\n<${PR_URL}|#${PR_NUMBER} - ${PR_TITLE}>"
                  }
                },
                {
                  "type": "divider"
                },
            EOF
            )
          fi
          
          # Commit body section if exists
          BODY_SECTION=""
          if [ -n "${{ steps.commit-info.outputs.commit_body }}" ]; then
            BODY_SECTION=$(cat << EOF
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üìÑ Full Description*\\n${COMMIT_BODY}"
                  }
                },
            EOF
            )
          fi
          
          # Changed files section if any
          FILES_SECTION=""
          if [ -n "${{ steps.commit-info.outputs.changed_files_list }}" ]; then
            FILES_SECTION=$(cat << EOF
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üìÅ Modified Files*\\n${CHANGED_FILES_LIST}"
                  }
                },
            EOF
            )
          fi
          
          # Create the payload
          payload=$(cat << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üöÄ New Deployment to Main",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*üìÇ Repository*\\n<${REPO_URL}|${{ github.repository }}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*üë§ Triggered By*\\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              ${PR_SECTION}
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*üë®‚Äçüíª Code Author*\\n${AUTHOR_DISPLAY}\\n${{ steps.commit-info.outputs.author_email }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*üë§ Committer*\\n${{ steps.commit-info.outputs.committer_name }}\\n${{ steps.commit-info.outputs.committer_email }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üìù Commit Message*\\n\\\`\\\`\\\`${{ steps.commit-info.outputs.commit_msg }}\\\`\\\`\\\`"
                }
              },
              ${BODY_SECTION}
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*üìä Files Changed*\\n${{ steps.commit-info.outputs.changed_files_count }} files"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*üìà Git Stats*\\n${{ steps.commit-info.outputs.git_stats }}"
                  }
                ]
              },
              ${FILES_SECTION}
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*üïê Commit Date*\\n${{ steps.commit-info.outputs.commit_date }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*üîó Commit Hash*\\n<${COMMIT_URL}|${{ steps.commit-info.outputs.short_sha }}>"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìù View Commit",
                      "emoji": true
                    },
                    "url": "${COMMIT_URL}",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "‚öôÔ∏è View Workflow",
                      "emoji": true
                    },
                    "url": "${RUN_URL}"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìÅ Repository",
                      "emoji": true
                    },
                    "url": "${REPO_URL}"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "üïí Notification sent: $(date -u +"%Y-%m-%d %H:%M:%S UTC") ‚Ä¢ Event: ${{ github.event_name }}"
                  }
                ]
              }
            ]
          }
          EOF
          )
          
          # Clean up JSON (remove empty sections)
          payload=$(echo "$payload" | sed '/^[[:space:]]*$/d' | sed 's/,\s*{/{/g' | sed 's/,\s*]/]/g')
          
          echo "Payload being sent:"
          echo "$payload"
          
          curl -X POST \
            -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"
